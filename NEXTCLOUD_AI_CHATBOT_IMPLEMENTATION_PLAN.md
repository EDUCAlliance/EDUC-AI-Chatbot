# Nextcloud AI Chatbot – Implementation Plan

> This plan is aligned with the project-wide *DEPLOYMENT_GUIDE.md* (composer handling, directory rules, security hardening) and *NEXTCLOUD_BOT_DOC.md* (webhook contract & signature flow). All paths assume they live under `/app/code/apps/nextcloud-bot/` when deployed by the PHP Git App Manager.

---

## 0  Repository Bootstrap
* **Root files**
  * `connect.php` — required Nextcloud webhook entry-point (must stay in repo root).
  * `composer.json` — autoload + dependencies (`slim/slim`, `twig/twig`, `openai-php/client`, `pgvector/php`, `vlucas/phpdotenv`, `symfony/polyfill-*`, `phpunit/phpunit` for dev).
  * `.htaccess` — auto-generated by deployment system; blocks sensitive paths (`vendor/`, `.git/`, `auto-include.php`, etc.).
* **App folder (isolation per guide)**
  ```text
  /apps/nextcloud-bot/
  ├── admin/          # Admin panel UI (Slim controllers + Twig views)
  │   ├── assets/     # Bulma CSS, JS helpers
  │   ├── templates/
  │   └── index.php   # Front-controller for admin routes
  ├── src/            # PHP domain logic
  │   ├── Services/   # ApiClient, EmbeddingService, VectorStore, OnboardingManager...
  │   ├── Models/     # Active-record style DB wrappers
  │   ├── Helpers/    # Logger, Validator, Csrf, Session
  │   └── bootstrap.php
  ├── uploads/        # Raw document uploads (blocked via .htaccess)
  ├── logs/           # One log file per day (see appLog helper)
  └── tests/          # PHPUnit tests
  ```

## 1  Environment Variables (set via manager UI)
| Key | Purpose |
|-----|---------|
| `BOT_TOKEN` | Shared secret for webhook HMAC validation |
| `NC_URL` | Nextcloud base domain (for reply API) |
| `AI_API_KEY` / `AI_API_ENDPOINT` | SAIA credentials; endpoint defaults to `https://chat-ai.academiccloud.de/v1` |
| `ADMIN_EMAIL` (opt.) | Password-reset helper |

*(All variables become available to PHP automatically thanks to the deployment system's `custom-env.php` + `auto-include.php` files.)*

## 2  Database Schema (PostgreSQL + pgvector)
Prefix every table with `bot_` to avoid clashes (see shared DB guidance).
```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE IF NOT EXISTS bot_admin (
  id SERIAL PRIMARY KEY,
  password_hash TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS bot_settings (
  id INTEGER PRIMARY KEY CHECK (id=1),
  mention TEXT DEFAULT '@educai',
  default_model TEXT DEFAULT 'meta-llama-3.1-8b-instruct',
  system_prompt TEXT,
  onboarding_group JSONB,
  onboarding_dm JSONB
);

CREATE TABLE IF NOT EXISTS bot_docs (
  id SERIAL PRIMARY KEY,
  filename TEXT,
  path TEXT,
  checksum CHAR(64),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS bot_embeddings (
  doc_id INT REFERENCES bot_docs(id) ON DELETE CASCADE,
  chunk_index INT,
  embedding VECTOR(1024),
  text TEXT,
  PRIMARY KEY (doc_id, chunk_index)
);

CREATE TABLE IF NOT EXISTS bot_conversations (
  id BIGSERIAL PRIMARY KEY,
  room_token TEXT,
  user_id TEXT,
  role TEXT,         -- user / assistant
  content TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS bot_room_config (
  room_token TEXT PRIMARY KEY,
  is_group BOOLEAN,
  mention_mode TEXT CHECK (mention_mode IN ('always','on_mention')),
  onboarding_done BOOLEAN DEFAULT FALSE,
  meta JSONB
);
```

## 3  Admin Panel (Slim + Twig)
1. **First-Run Wizard**
   * If `bot_admin` empty → force password creation → seed `bot_settings` rows.
   * BCrypt hashing (`password_hash`).
2. **Authentication** — session-based, CSRF protected.
3. **Views**
   * **Dashboard** — stats (total docs, embeddings, rooms) using snippets from deployment guide.
   * **Documents** — upload ➜ parse ➜ chunk ➜ call embeddings endpoint ➜ store vectors.
   * **Models** — real-time fetch from `/v1/models` (see *AI_API.md*), display capabilities, allow selection, latency test.
   * **System Prompt** — textarea editor; persisted in `bot_settings.system_prompt`.
   * **Onboarding Config** — editable question lists (separate JSON arrays for group vs DM), mention string, reply mode.

## 4  Services
* **ApiClient** — wrapper around SAIA/OpenAI-style endpoints (chat, embeddings, models).
* **EmbeddingService** — splits documents (≈1 000 tokens / chunk), calls embeddings endpoint, stores vectors.
* **VectorStore** — pgvector cosine search (`ORDER BY embedding <-> :query LIMIT k`).
* **OnboardingManager** — state machine stored in `bot_room_config.meta.stage`.
* **Logger / Validator / Csrf / Session** — copy patterns from *DEPLOYMENT_GUIDE.md*.

## 5  Webhook Flow (`connect.php`)
1. **Security** – verify `X-Nextcloud-Talk-Signature` using `BOT_TOKEN` (see example in *NEXTCLOUD_BOT_DOC.md*).
2. **Early-exit logic**
   * Not our mention & `mention_mode = on_mention` → exit.
3. **Room config**
   * Fetch / create row in `bot_room_config`.
   * If `onboarding_done = FALSE` → delegate to `OnboardingManager`, store & ask next question.
4. **Conversation**
   * Append incoming user message to `bot_conversations`.
   * Fetch last N history messages.
5. **RAG Context**
   * Build embedding for user text, similarity search top-k, merge chunks into system context.
6. **LLM Call**
   * Compose messages: system prompt (global) + onboarding meta + RAG context + history + user.
   * POST `/chat/completions` with `model = settings.default_model`.
7. **Reply**
   * Store assistant message into `bot_conversations`.
   * Sign & POST reply JSON to `https://$NC_URL/ocs/v2.php/apps/spreed/api/v1/bot/{room}/message`.

## 6  Onboarding Dialogue
| Stage | Question (default) | Notes |
|-------|--------------------|-------|
| 0 | "Is this a group chat (yes/no)?" | Sets `is_group`. |
| 1  | "Should I respond to every message or only when mentioned (@educai)?" | Saves `mention_mode`. |
| 2…n | Custom questions from admin panel (different list for DM vs group) | Responses stored in `bot_room_config.meta.answers`. |
| end | Mark `onboarding_done = TRUE` | Answers merged into future system prompt. |

## 7  Security & Compliance
* `.htaccess` protections auto-generated; ensure `uploads/` is denied.
* Sanitize env vars in any debug output (use `sanitizeEnvVar()` snippet).
* Admin routes enforce CSRF token & HTTPS.
* All SQL via prepared statements.

## 8  Testing & CI
* **Unit Tests** – PHPUnit for services & DB layer (using in-memory pg / test db).
* **Webhook E2E** – simulate POST JSON and assert response, DB insert.
* **Static Analysis** – PHPStan level 8.

## 9  Deployment Notes (per DEPLOYMENT_GUIDE)
1. Composer install is auto-detected; keep `vendor/` out of repo.
2. Any missing `index.php` will trigger auto-landing page — we have one, so OK.
3. The deployment log (`deployment.log`) can confirm `.htaccess` rules.
4. pgvector extension is pre-enabled in Cloudron image; verify in debug panel.

## 10  Future Enhancements
* Streaming responses to Nextcloud (chunked edits).
* Per-room prompt overrides.
* Document export/import.
* Multi-language onboarding templates.

---

**Ready for production:** the above delivers a fully-featured, secure PHP Nextcloud chatbot that follows both the Cloudron deployment conventions and the Nextcloud webhook contract while providing admin-managed RAG, dynamic LLM selection, and guided onboarding. 
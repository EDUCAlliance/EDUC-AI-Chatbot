{% extends "layout.twig" %}

{% block title %}Manage Documents{% endblock %}

{% block heading %}Documents{% endblock %}

{% block content %}
    <div class="box">
        <div class="level">
            <div class="level-left">
                <h2 class="subtitle">Manage Knowledge Base for:</h2>
            </div>
            <div class="level-right">
                <form id="botSelectorForm" method="get" action="{{ url_for('documents') }}">
                    <div class="field has-addons">
                        <div class="control">
                            <div class="select is-medium">
                                <select name="bot_id" onchange="document.getElementById('botSelectorForm').submit()">
                                    {% for bot in bots %}
                                        <option value="{{ bot.id }}" {{ bot.id == currentBotId ? 'selected' : '' }}>
                                            {{ bot.bot_name }}
                                        </option>
                                    {% else %}
                                        <option>No bots available</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="control">
                             <button type="submit" class="button is-info is-medium">
                                <span class="icon"><i class="fas fa-filter"></i></span>
                                <span>Switch Bot</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <hr>

        {% if currentBotId %}
            <h3 class="title is-5">Upload New Document to <span class="has-text-primary">{{ bots|filter(b => b.id == currentBotId)|first.bot_name }}</span></h3>
            
            <!-- Hidden bot_id field for async upload -->
            <input type="hidden" id="botIdForUpload" value="{{ currentBotId }}">

            <!-- Upload Area -->
            <div class="upload-area" id="uploadArea">
                <div class="file has-name is-fullwidth is-large" id="fileSelector">
                    <label class="file-label">
                        <input class="file-input" type="file" name="document" id="documentInput" accept=".pdf,.txt,.doc,.docx,.md">
                        <span class="file-cta">
                            <span class="file-icon">
                                <i class="fas fa-upload"></i>
                            </span>
                            <span class="file-label">
                                Choose a document to uploadâ€¦
                            </span>
                        </span>
                        <span class="file-name" id="fileName">
                            No file selected
                        </span>
                    </label>
                </div>
            </div>

            <!-- Upload/Embedding Progress, Messages, etc. -->
            {% include 'partials/_upload_progress.twig' %}

            <!-- Action Buttons -->
            <div class="field is-grouped mt-4">
                <div class="control">
                    <button class="button is-primary" id="uploadBtn" disabled>
                        <span class="icon"><i class="fas fa-cloud-upload-alt"></i></span>
                        <span>Upload and Process</span>
                    </button>
                </div>
                <div class="control">
                    <button class="button is-light" id="cancelBtn" style="display: none;">
                        <span class="icon"><i class="fas fa-times"></i></span>
                        <span>Cancel</span>
                    </button>
                </div>
                <div class="control">
                    <button class="button is-info is-light" id="clearBtn" style="display: none;">
                        <span class="icon"><i class="fas fa-sync-alt"></i></span>
                        <span>Clear</span>
                    </button>
                </div>
            </div>
        {% else %}
             <div class="notification is-warning">
                Please <a href="{{ url_for('bots.create') }}">create a bot</a> first before uploading documents.
            </div>
        {% endif %}
    </div>

    {% if currentBotId %}
    <div class="box mt-5">
        <h2 class="subtitle">Uploaded Documents for <span class="has-text-primary">{{ bots|filter(b => b.id == currentBotId)|first.bot_name }}</span></h2>
        <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>Uploaded At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="documentsTable">
                    {% for doc in docs %}
                    <tr data-doc-id="{{ doc.id }}">
                        <td>
                            <span class="icon-text">
                                <span class="icon"><i class="fas fa-file-alt"></i></span>
                                <span>{{ doc.filename }}</span>
                            </span>
                        </td>
                        <td>
                            <span class="tag is-success is-light">
                                <span class="icon"><i class="fas fa-check"></i></span>
                                <span>Ready</span>
                            </span>
                        </td>
                        <td>{{ doc.created_at|date('Y-m-d H:i:s') }}</td>
                        <td>
                            <button type="button" class="button is-danger is-small delete-doc-btn" data-doc-id="{{ doc.id }}" data-filename="{{ doc.filename }}">
                                <span class="icon"><i class="fas fa-trash"></i></span>
                                <span>Delete</span>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr id="noDocsRow">
                        <td colspan="4" class="has-text-centered has-text-grey">No documents have been uploaded for this bot yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Delete Confirmation Modal -->
    {% include 'partials/_delete_modal.twig' %}
    
    <style>
        .upload-area .file-cta {
            background-color: #f5f5f5;
        }
        .upload-area .file-cta:hover {
            background-color: #eeeeee;
        }
    </style>

    <script src="../admin/assets/js/documents.js?v=2"></script>
{% endblock %} 
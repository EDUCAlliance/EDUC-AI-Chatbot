{% extends "layout.twig" %}

{% block title %}RAG Configuration{% endblock %}
{% block heading %}RAG Configuration{% endblock %}

{% block content %}
<div class="box">
    <div class="level mb-5">
        <div class="level-left">
            <div class="level-item">
                <div>
                    <h2 class="subtitle has-text-weight-semibold mb-2">
                        <span class="icon-text">
                            <span class="icon has-text-primary">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </span>
                            <span>Retrieval-Augmented Generation</span>
                        </span>
                    </h2>
                    <p class="has-text-grey">Configure how the AI processes and retrieves information from your documents.</p>
                </div>
            </div>
        </div>
    </div>

    <form action="{{ url_for('rag-settings') }}" method="post" id="ragForm">
        <div class="columns">
            <div class="column is-half">
                <div class="field">
                    <label class="label">
                        <span class="icon-text">
                            <span class="icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M12 1v6m0 6v6"/>
                                    <path d="m21 12-6 0m-6 0-6 0"/>
                                </svg>
                            </span>
                            <span>Embedding Model</span>
                        </span>
                    </label>
                    <div class="control">
                        <div class="select is-fullwidth is-medium">
                            <select name="embedding_model" id="embeddingModel">
                                {% for model in embeddingModels %}
                                    <option value="{{ model.id }}" {{ model.id == settings.embedding_model ? 'selected' : '' }}>
                                        {{ model.id }}
                                    </option>
                                {% else %}
                                     <option value="e5-mistral-7b-instruct" selected>e5-mistral-7b-instruct (default)</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <p class="help">
                        <span class="icon-text">
                            <span class="icon has-text-info">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                            </span>
                            <span>The model used to create numerical representations (embeddings) of your documents.</span>
                        </span>
                    </p>
                </div>

                <div class="field">
                    <label class="label">
                        <span class="icon-text">
                            <span class="icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16l-3-1m3 1l3-1"/>
                                </svg>
                            </span>
                            <span>Top-K Results</span>
                        </span>
                    </label>
                    <div class="control">
                        <input class="input is-medium" type="number" name="rag_top_k" id="topK" 
                               value="{{ settings.rag_top_k }}" min="1" max="20" step="1">
                    </div>
                    <p class="help">
                        <span class="icon-text">
                            <span class="icon has-text-info">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                            </span>
                            <span>Maximum number of relevant document chunks to retrieve for context. <strong>Recommended: 3-5</strong></span>
                        </span>
                    </p>
                </div>
            </div>

            <div class="column is-half">
                <div class="field">
                    <label class="label">
                        <span class="icon-text">
                            <span class="icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" x2="16" y1="2" y2="6"/>
                                    <line x1="8" x2="8" y1="2" y2="6"/>
                                    <line x1="3" x2="21" y1="10" y2="10"/>
                                </svg>
                            </span>
                            <span>Chunk Size (words)</span>
                        </span>
                    </label>
                    <div class="control">
                        <input class="input is-medium" type="number" name="rag_chunk_size" id="chunkSize" 
                               value="{{ settings.rag_chunk_size }}" min="50" max="1000" step="25">
                    </div>
                    <p class="help">
                        <span class="icon-text">
                            <span class="icon has-text-info">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                            </span>
                            <span>Target size for text chunks when splitting documents. <strong>Recommended: 200-300</strong></span>
                        </span>
                    </p>
                </div>
                
                <div class="field">
                    <label class="label">
                        <span class="icon-text">
                            <span class="icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 3H5a2 2 0 0 0-2 2v3m2-5h3m0 0h3m-3 0v3m3-3h3a2 2 0 0 1 2 2v3M8 21h3m0 0h3m-3 0v-3m3 3h3a2 2 0 0 0 2-2v-3"/>
                                </svg>
                            </span>
                            <span>Chunk Overlap (words)</span>
                        </span>
                    </label>
                    <div class="control">
                        <input class="input is-medium" type="number" name="rag_chunk_overlap" id="chunkOverlap" 
                               value="{{ settings.rag_chunk_overlap }}" min="0" max="100" step="5">
                    </div>
                    <p class="help">
                        <span class="icon-text">
                            <span class="icon has-text-info">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="m9 12 2 2 4-4"/>
                                </svg>
                            </span>
                            <span>Words that overlap between consecutive chunks. <strong>Recommended: 10-25</strong></span>
                        </span>
                    </p>
                </div>
            </div>
        </div>

        <div class="notification is-warning is-light" id="validationWarning" style="display: none;">
            <h5 class="title is-6">
                <span class="icon-text">
                    <span class="icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" x2="12" y1="9" y2="13"/>
                            <line x1="12" x2="12.01" y1="17" y2="17"/>
                        </svg>
                    </span>
                    <span>Configuration Warning</span>
                </span>
            </h5>
            <div id="warningContent"></div>
        </div>

        <div class="notification is-info is-light">
            <h5 class="title is-6">
                <span class="icon-text">
                    <span class="icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" x2="12.01" y1="17" y2="17"/>
                        </svg>
                    </span>
                    <span>RAG Configuration Guide</span>
                </span>
            </h5>
            <div class="content is-small">
                <div class="columns">
                    <div class="column">
                        <h6 class="title is-6">Best Practices:</h6>
                        <ul>
                            <li><strong>Top-K:</strong> Start with 3-5 for balanced performance</li>
                            <li><strong>Chunk Size:</strong> 200-300 words for most documents</li>
                            <li><strong>Overlap:</strong> 10-25 words to maintain context</li>
                        </ul>
                    </div>
                    <div class="column">
                        <h6 class="title is-6">Performance Impact:</h6>
                        <ul>
                            <li><strong>Higher Top-K:</strong> More context but slower responses</li>
                            <li><strong>Larger Chunks:</strong> Better context but less precision</li>
                            <li><strong>More Overlap:</strong> Better continuity but more storage</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="field">
            <div class="control">
                <button class="button is-primary is-medium" type="submit" id="saveBtn">
                    <span class="icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                    </span>
                    <span>Save RAG Settings</span>
                </button>
                <button class="button is-light is-medium ml-3" type="button" id="resetBtn">
                    <span class="icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="1 4 1 10 7 10"/>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                        </svg>
                    </span>
                    <span>Reset to Defaults</span>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('ragForm');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const topK = document.getElementById('topK');
    const chunkSize = document.getElementById('chunkSize');
    const chunkOverlap = document.getElementById('chunkOverlap');
    const validationWarning = document.getElementById('validationWarning');
    const warningContent = document.getElementById('warningContent');

    // Store original values
    const originalValues = {
        topK: topK.value,
        chunkSize: chunkSize.value,
        chunkOverlap: chunkOverlap.value
    };

    // Validation function
    function validateSettings() {
        const warnings = [];
        const topKVal = parseInt(topK.value);
        const chunkSizeVal = parseInt(chunkSize.value);
        const chunkOverlapVal = parseInt(chunkOverlap.value);

        if (topKVal > 10) {
            warnings.push('High Top-K values (>10) may slow down responses significantly.');
        }
        if (chunkSizeVal < 100) {
            warnings.push('Very small chunk sizes (<100) may lose important context.');
        }
        if (chunkSizeVal > 500) {
            warnings.push('Very large chunk sizes (>500) may reduce precision.');
        }
        if (chunkOverlapVal >= chunkSizeVal * 0.5) {
            warnings.push('Chunk overlap should be less than 50% of chunk size.');
        }

        if (warnings.length > 0) {
            warningContent.innerHTML = '<ul>' + warnings.map(w => `<li>${w}</li>`).join('') + '</ul>';
            validationWarning.style.display = 'block';
        } else {
            validationWarning.style.display = 'none';
        }
    }

    // Check for changes and validate
    function checkChanges() {
        const hasChanges = topK.value !== originalValues.topK || 
                          chunkSize.value !== originalValues.chunkSize || 
                          chunkOverlap.value !== originalValues.chunkOverlap;

        if (hasChanges) {
            saveBtn.classList.add('is-warning');
            saveBtn.innerHTML = '<span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg></span><span>Save Changes</span>';
        } else {
            saveBtn.classList.remove('is-warning');
            saveBtn.innerHTML = '<span class="icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg></span><span>Save RAG Settings</span>';
        }

        validateSettings();
    }

    // Add event listeners
    [topK, chunkSize, chunkOverlap].forEach(input => {
        input.addEventListener('input', checkChanges);
    });

    // Form submission
    form.addEventListener('submit', function() {
        saveBtn.classList.add('is-loading');
        saveBtn.disabled = true;
    });

    // Reset to defaults
    resetBtn.addEventListener('click', function() {
        if (confirm('Reset all RAG settings to recommended defaults?')) {
            topK.value = '3';
            chunkSize.value = '250';
            chunkOverlap.value = '25';
            checkChanges();
        }
    });

    // Initial validation
    validateSettings();
});
</script>
{% endblock %} 